<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Transcription Vocale Accessible</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html { height: -webkit-fill-available; }
        body {
            font-family: 'Atkinson Hyperlegible', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            background-color: #f9fafb;
        }
        #text-container {
            flex: 1 1 auto;
            font-size: 22px;
            line-height: 1.6;
            touch-action: pan-y; 
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        footer { flex-shrink: 0; }
        .is-listening { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 25px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2563eb; }
        input:checked + .slider:before { transform: translateX(22px); }
    </style>
</head>
<body>

    <div id="text-container" class="w-full p-4 text-left select-none">
        <p id="transcript" class="text-gray-900 whitespace-pre-wrap"></p>
    </div>

    <footer class="w-full p-4 bg-white border-t border-gray-200 shadow-t-lg pb-8 md:pb-4">
        <p id="status" class="text-center text-gray-500 mb-4 h-6 transition-all duration-300">Maintenez pour parler</p>
        <div class="relative flex justify-center items-center space-x-5">
            <button id="clearButton" class="bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-full p-4 transition-transform duration-200 active:scale-90 shadow-md" title="Effacer le texte">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            </button>
            
            <button id="micButton" class="bg-blue-600 text-white rounded-full p-5 transition-all duration-300 shadow-lg" title="Maintenir pour parler">
                <svg id="micIcon" xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zM17.3 11c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/></svg>
            </button>
            
            <div class="flex flex-col items-center">
                <label class="switch">
                    <input type="checkbox" id="modeToggle">
                    <span class="slider"></span>
                </label>
                <span class="text-xs text-gray-500 mt-1">Continu</span>
            </div>

            <a href="help.html" class="absolute right-4 top-1/2 -translate-y-1/2 bg-gray-200 hover:bg-gray-300 text-gray-600 rounded-full p-3 transition-transform duration-200 active:scale-90 shadow-md" title="Aide">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.546-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </a>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const micButton = document.getElementById('micButton');
            const clearButton = document.getElementById('clearButton');
            const modeToggle = document.getElementById('modeToggle');
            const status = document.getElementById('status');
            const transcriptEl = document.getElementById('transcript');
            const textContainer = document.getElementById('text-container');

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                status.textContent = "Désolé, la reconnaissance vocale n'est pas supportée.";
                micButton.disabled = true; modeToggle.disabled = true; return;
            }

            const recognition = new SpeechRecognition();
            recognition.lang = 'fr-FR';
            recognition.interimResults = true;

            let isListening = false;
            let finalTranscript = '';
            let isAlwaysOn = false;

            const scrollToBottom = () => textContainer.scrollTop = textContainer.scrollHeight;

            const loadState = () => {
                finalTranscript = localStorage.getItem('voiceNoteText_v11') || '';
                transcriptEl.textContent = finalTranscript;
                textContainer.style.fontSize = localStorage.getItem('voiceNoteFontSize_v11') || '22px';
                isAlwaysOn = localStorage.getItem('voiceNoteMode_v11') === 'true';
                modeToggle.checked = isAlwaysOn;
                updateMicMode();
                scrollToBottom();
            };

            const updateUIState = (isRecording) => {
                if (isRecording) {
                    micButton.classList.add('is-listening', 'bg-red-500');
                    micButton.classList.remove('bg-blue-600');
                    status.textContent = "J'écoute...";
                } else {
                    micButton.classList.remove('is-listening', 'bg-red-500');
                    micButton.classList.add('bg-blue-600');
                    status.textContent = isAlwaysOn ? "Cliquez sur le micro" : "Maintenez pour parler";
                }
            };
            
            const updateMicMode = () => {
                isAlwaysOn = modeToggle.checked;
                localStorage.setItem('voiceNoteMode_v11', isAlwaysOn);
                recognition.continuous = isAlwaysOn;
                if (isListening) recognition.stop();
                updateUIState(false);
            };

            const startListening = (e) => {
                if (e) e.preventDefault();
                if (isListening) return;
                isListening = true;
                recognition.start();
            };

            const stopListening = () => {
                if (!isListening) return;
                isListening = false;
                recognition.stop();
            };

            modeToggle.addEventListener('change', updateMicMode);
            micButton.addEventListener('click', (e) => isAlwaysOn && (isListening ? stopListening() : startListening(e)));
            micButton.addEventListener('mousedown', (e) => !isAlwaysOn && startListening(e));
            micButton.addEventListener('mouseup', () => !isAlwaysOn && stopListening());
            micButton.addEventListener('mouseleave', () => !isAlwaysOn && stopListening());
            micButton.addEventListener('touchstart', (e) => !isAlwaysOn && startListening(e), { passive: false });
            micButton.addEventListener('touchend', () => !isAlwaysOn && stopListening());

            clearButton.addEventListener('click', () => {
                finalTranscript = '';
                transcriptEl.textContent = '';
                localStorage.setItem('voiceNoteText_v11', '');
                status.textContent = "Texte effacé";
            });

            recognition.onstart = () => updateUIState(true);
            
            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript_rebuilt = '';
                for (let i = 0; i < event.results.length; ++i) {
                    const transcriptPart = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript_rebuilt += transcriptPart.trim() + '\n';
                    } else {
                        interimTranscript += transcriptPart;
                    }
                }
                finalTranscript = finalTranscript_rebuilt;
                transcriptEl.textContent = finalTranscript + interimTranscript;
                scrollToBottom();
                localStorage.setItem('voiceNoteText_v11', finalTranscript);
            };

            recognition.onend = () => {
                isListening = false;
                updateUIState(false);
                // Si le mode continu est activé, redémarre la reconnaissance
                if (isAlwaysOn) {
                    startListening();
                }
            };

            recognition.onerror = (event) => {
                console.error("Erreur:", event.error);
                if (event.error !== 'no-speech') status.textContent = `Erreur: ${event.error}`;
                isListening = false;
                updateUIState(false);
            };

            // --- GESTION DU ZOOM & SCROLL ---
            let initialPinchDistance = null; let initialFontSize = 22;
            const getDistance = (touches) => Math.hypot(touches[0].pageX - touches[1].pageX, touches[0].pageY - touches[1].pageY);

            textContainer.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    textContainer.style.touchAction = 'none';
                    initialPinchDistance = getDistance(e.touches);
                    initialFontSize = parseFloat(window.getComputedStyle(textContainer).fontSize);
                }
            }, { passive: false });

            textContainer.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2 && initialPinchDistance) {
                    e.preventDefault();
                    const currentDistance = getDistance(e.touches);
                    const scale = currentDistance / initialPinchDistance;
                    textContainer.style.fontSize = `${Math.max(12, Math.min(initialFontSize * scale, 120))}px`;
                }
            }, { passive: false });

            textContainer.addEventListener('touchend', (e) => {
                if (initialPinchDistance) {
                    localStorage.setItem('voiceNoteFontSize_v11', textContainer.style.fontSize);
                    initialPinchDistance = null;
                }
                textContainer.style.touchAction = 'pan-y';
            });

            loadState();
        });
    </script>
</body>
</html>
